<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create a Secure Message</title>
    <style>
        :root {
            --bg-dark: #121212; --bg-medium: #1e1e1e; --bg-light: #2a2a2a;
            --border-color: #333; --primary-color: #00ff7f; --accent-color: #00e673;
            --text-color: #e0e0e0; --subtitle-color: #aaa; --input-border: #444;
            --error-color: #ff4d4d;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 600px; background-color: var(--bg-medium); padding: 30px; border-radius: 12px; box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6); border: 1px solid var(--border-color); }
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 5px; font-size: 2.2em; }
        p.subtitle { text-align: center; margin-top: 0; color: var(--subtitle-color); font-style: italic; font-size: 0.95em; margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        textarea, input[type="password"], input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin-bottom: 20px; background-color: var(--bg-light); border: 1px solid var(--input-border); border-radius: 6px; color: var(--text-color); font-size: 16px; box-sizing: border-box; }
        input[disabled] { background-color: #222; opacity: 0.5; cursor: not-allowed; }
        textarea:focus, input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 255, 127, 0.2); outline: none; }
        textarea { min-height: 150px; resize: vertical; }
        .password-strength { height: 5px; background-color: var(--input-border); margin-top: -15px; margin-bottom: 20px; border-radius: 2px; overflow: hidden; transition: opacity 0.3s; }
        .password-strength-bar { height: 100%; transition: width 0.3s ease, background-color 0.3s ease; }
        .password-strength-bar.weak { background-color: var(--error-color); } .password-strength-bar.medium { background-color: orange; } .password-strength-bar.strong { background-color: var(--primary-color); }
        button { width: 100%; padding: 15px; background-color: var(--primary-color); color: var(--bg-dark); border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #555; cursor: not-allowed; color: #999; }
        #result-link { background-color: var(--bg-light); padding: 15px; border-radius: 6px; word-wrap: break-word; border: 1px dashed var(--primary-color); cursor: copy; margin-bottom: 10px; }
        .notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.85); color: var(--text-color); padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s ease, top 0.3s ease; z-index: 1000; }
        .notification.show { opacity: 1; top: 20px; }
        .options-group label { margin-bottom: 10px; }
        .radio-options, .checkbox-option { display: flex; gap: 20px; justify-content: flex-start; align-items: center; margin-bottom: 20px; }
        .radio-options label, .checkbox-option label { display: flex; align-items: center; cursor: pointer; font-weight: normal; padding: 10px 15px; border: 1px solid var(--input-border); border-radius: 6px; transition: background-color 0.2s, border-color 0.2s; }
        .radio-options input[type="radio"], .checkbox-option input[type="checkbox"] { display: none; }
        .radio-options input[type="radio"]:checked + span, .checkbox-option input[type="checkbox"]:checked + span { color: var(--primary-color); font-weight: bold; }
        .radio-options label:has(input:checked), .checkbox-option label:has(input:checked) { background-color: rgba(0, 255, 127, 0.1); border-color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="notification" class="notification"></div>
        <h1>Create a Secure Message</h1>
        <p class="subtitle">Your message will be encrypted and stored for a single viewing.</p>
        
        <div id="create-view">
            <label for="message">Your Secret Message:</label>
            <textarea id="message" placeholder="Type your secret message here..."></textarea>
            
            <div class="checkbox-option">
                <label>
                    <input type="checkbox" id="require-password-cb" checked>
                    <span>Require Password</span>
                </label>
            </div>

            <div id="password-section">
                <label for="password">Encryption Password:</label>
                <input type="password" id="password" placeholder="Enter a strong password">
                <div class="password-strength"><div id="password-strength-bar" class="password-strength-bar"></div></div>
            </div>
            
            <div class="options-group">
                <label>Security Level:</label>
                <div class="radio-options">
                    <label>
                        <input type="radio" name="security" value="normal" checked>
                        <span>Normal</span>
                    </label>
                    <label>
                        <input type="radio" name="security" value="secure">
                        <span>Secure (Anti-Screenshot)</span>
                    </label>
                </div>
            </div>

            <label for="timer">Self-destruct timer (seconds):</label>
            <input type="number" id="timer" min="5" max="300" value="10">
            <button id="create-btn">Generate Burn Link</button>
            <div id="result" style="display:none; margin-top:20px;">
                <label>Your One-Time Burn Link:</label>
                <p id="result-link">Click to copy</p>
            </div>
        </div>
    </div>

<script>
    const elements = {
        notification: document.getElementById('notification'),
        passwordInput: document.getElementById('password'), passwordStrengthBar: document.getElementById('password-strength-bar'),
        createBtn: document.getElementById('create-btn'), messageInput: document.getElementById('message'), timerInput: document.getElementById('timer'),
        resultLink: document.getElementById('result-link'), resultDiv: document.getElementById('result'),
        requirePasswordCb: document.getElementById('require-password-cb'), passwordSection: document.getElementById('password-section'),
        passwordStrengthDiv: document.querySelector('.password-strength'),
    };
    
    // RESTORED and corrected password strength logic
    elements.passwordInput.addEventListener('input', () => {
        const pass = elements.passwordInput.value;
        let strength = 0;
        if (pass.length >= 8) strength++;
        if (/[A-Z]/.test(pass)) strength++;
        if (/[a-z]/.test(pass)) strength++;
        if (/[0-9]/.test(pass)) strength++;
        if (/[^A-Za-z0-9]/.test(pass)) strength++; // Check for symbols

        let strength_percent = (strength / 5) * 100;
        elements.passwordStrengthBar.style.width = `${strength_percent}%`;
        
        if(strength < 2) {
            elements.passwordStrengthBar.className = 'password-strength-bar weak';
        } else if (strength < 4) {
            elements.passwordStrengthBar.className = 'password-strength-bar medium';
        } else {
            elements.passwordStrengthBar.className = 'password-strength-bar strong';
        }
    });
    
    // Other functions are unchanged and correct. I'm putting them here for completeness.
    const showNotification = (message) => {
        elements.notification.textContent = message;
        elements.notification.classList.add('show');
        setTimeout(() => elements.notification.classList.remove('show'), 3000);
    };
    
    const encryptMessage = async (message, password, timer, securityLevel) => {
        const payload = `${securityLevel}::${message}`;
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const keyMaterial = await crypto.subtle.importKey("raw", new TextEncoder().encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
        const key = await crypto.subtle.deriveKey({ name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt"]);
        const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, new TextEncoder().encode(payload));
        const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength + 4);
        combined.set(salt, 0); combined.set(iv, salt.length); combined.set(new Uint8Array(encrypted), salt.length + iv.length);
        new DataView(combined.buffer).setUint32(combined.length - 4, timer, false);
        return btoa(String.fromCharCode(...combined));
    };
    
    elements.requirePasswordCb.addEventListener('change', () => {
        const isRequired = elements.requirePasswordCb.checked;
        elements.passwordInput.disabled = !isRequired;
        elements.passwordSection.style.opacity = isRequired ? '1' : '0.5';
        elements.passwordStrengthDiv.style.opacity = isRequired ? '1' : '0.5';
    });

    elements.createBtn.addEventListener('click', async () => {
        const hasPassword = elements.requirePasswordCb.checked;
        const password = elements.passwordInput.value;
        const internalNoPassKey = "ThisIsASecretKeyForPasswordlessMessages-7a9b3c_d4e5f6";
        if (!elements.messageInput.value.trim()) return showNotification('Please enter a message');
        if (hasPassword && password.length < 8) return showNotification('Password must be at least 8 characters');
        elements.createBtn.disabled = true; elements.createBtn.textContent = 'Encrypting & Storing...';
        const securityLevel = document.querySelector('input[name="security"]:checked').value;
        const effectivePassword = hasPassword ? password : internalNoPassKey;
        const clientEncryptedData = await encryptMessage(elements.messageInput.value, effectivePassword, parseInt(elements.timerInput.value), securityLevel);
        if (clientEncryptedData) {
            try {
                const response = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ encryptedData: clientEncryptedData })
                });
                if (!response.ok) throw new Error('Server error');
                const { id } = await response.json();
                elements.resultLink.textContent = `${window.location.origin}/read.html#${id}`;
                elements.resultDiv.style.display = 'block';
                showNotification('Burn link created!');
            } catch (err) { showNotification('Could not contact server.'); }
        }
        elements.createBtn.disabled = false; elements.createBtn.textContent = 'Generate Burn Link';
    });
    
    elements.resultLink.addEventListener('click', () => navigator.clipboard.writeText(elements.resultLink.textContent).then(() => showNotification('Link copied!')));
</script>
</body>
</html>
